<!doctype html>
<head>
    <title>I wanna CTF</title>
    <style>
      html {
        font-family: 'Arial';
        margin: 20px;
      }

      div {
        margin-bottom: 20px;
      }

      ul {
        list-style-type: none;
      }
    </style>
</head>
<body>
  <div class="wrapper">
    <input type="text" placeholder="My name" autofocus> <input type="button" value="I wanna CTF">
  </div>
  <div class="message"></div>
  The following fine people want to play:
  <ul>
  </ul>

  <script>
      getSubscription().then(subscription => {
        if (subscription) {
          hasJoined = true;
        }
        updateUI();
      });

      const input = document.querySelector('input[type=text]');
      const button = document.querySelector('input[type=button]');
      const message = document.querySelector('.message');
      let vapidPublicKey;
      let hasJoined = false;

      input.addEventListener('keyup', event => {
        if(event.key !== 'Enter') return;
        button.click();
        event.preventDefault();
      });

      input.value = localStorage.getItem('name');

      const host = location.origin.replace(/^http/, 'ws')
      const socket = new WebSocket(host);
      socket.onmessage = (msg) => {
        const packet = JSON.parse(msg.data);
        if (packet.type === 'players') {
          const list = document.querySelector('ul');
          list.innerHTML = packet.players.map(player => `<li>${escapeHTML(player)}</li>`).join('');
        } else if (packet.type === 'vapid') {
          vapidPublicKey = packet.key;
        }
      };

      button.onclick = () => {
        hasJoined = !hasJoined;
        updateUI();
      }

      function updateUI() {
        if (hasJoined) {
          const name = input.value;
          send({type: 'join', name});
          localStorage.setItem('name', name)

          if (vapidPublicKey) {
            startPushSubscription(vapidPublicKey);
          }

          input.style.display = 'none';
          message.textContent = 'You\'re in! You will get notifications even if you close this tab.';

          button.value = 'I don\'t wanna CTF anymore';
        } else {
          send({type: 'leave'});
          unsubscribe();

          input.style.display = 'inline';
          message.textContent = '';
          button.value = 'I wanna CTF';
        }
      }

      function send(data) {
        if (socket && socket.readyState === 1) {
          socket.send(JSON.stringify(data));
        }
      }

      function startPushSubscription(vapidKey) {
        Notification.requestPermission().then(async result => {
          await unsubscribe();
          if (!navigator.serviceWorker) {
            return;
          }
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          await navigator.serviceWorker.ready;
          const pushSubscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidKey)
          });
          send({type: 'push-subscription', pushSubscription: pushSubscription});
        });
      }

      function getSubscription() {
        return Notification.requestPermission().then(async result => {
          if (!navigator.serviceWorker) {
            return;
          }
          let registration = await navigator.serviceWorker.getRegistration()
          if (registration) {
            return registration.pushManager.getSubscription();
          }
        });
      }

      function unsubscribe() {
        return Notification.requestPermission().then(async result => {
          if (!navigator.serviceWorker) {
            return;
          }
          let registration = await navigator.serviceWorker.getRegistration()
          if (registration) {
            let subscription = await registration.pushManager.getSubscription();
            if (subscription) {
             subscription.unsubscribe();
            }
            registration.unregister();
          }
        });
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
          .replace(/\-/g, '+')
          .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      function escapeHTML(unsafe) {
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
       }
  </script>
</body>